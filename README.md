# USC Program of Studies

Hi! If you are reading this, then you probably need to maintain this software, or to change something. Good luck! I'll try to help you out as much as possible.

Hopefully you are familiar with the current system, both from the teacher/admin page and from the student experience.

Some experience in Javascript, Python, Django, and Apache is recommended.

I recommend reading through the whole README to understand how the code works, what the dependencies are, and how to build and deploy.

## Structure

This software is split into two parts. The frontend, which is written in Vue 3 (was Vue 2, but I migrated it), and the backend, which is written in Django and Python. The frontend handles what the student sees, and the backend handles the data as well as the admin page.

### Backend

Now for some more details about the backend. The backend stores all information in a SQLite 3 database. There are commands that can import data into the database, but they are essentially useless because the data has changed so much over the years.

There is also a file upload place (in the `media` folder) for hosting PDFs that students may need to see.

There are two main parts of the backend. The API (seen in the `api` folder) and the admin page (which is auto-generated by Django based on the data types in the API). Hopefully you will only need to touch the API to add or remove fields (or change the wording / order of items). That can be done fairly easily by modifying the `models.py` file in the `api` folder.

The admin page is designed to be protected by a reverse proxy (please use a reverse proxy). The reverse proxy handles authentication and authorization and passes the username of the user who has just logged in through an HTTP header. I only made the configuration for Apache. There are some environment variables that are important for running this project.

- `AUTH_HEADER`: The name of the header to check for the username. Make sure that the reverse proxy sanitizes this value because if it isn't set up right, then anyone can log into the admin page by telling their browser to send an additional header.
- `SECRET_KEY`: A secret key for login cookies and making the application all around more secure. Make sure this is long (256+ bits of security) and random.
- `DOMAIN`: The domain that this project is planned to be deployed on.
- `ENV_NAME`: Are we running in production or in development? Set this variable accordingly. The Docker image overrides this to `production`.
- `DEBUG` (optional): If this is set to "true", then Django's debug mode is enabled. Note that when running with Gunicorn that this doesn't change anything.
- `CONFIG_DIR` (optional): Location to save the database and uploaded media. If not set, it defaults to the location where `manage.py` is.

Some terms you have to understand:

- [Gunicorn](https://gunicorn.org) is what is (or at least should be) running this application in production. It's very fast and easy to use.
- Header-Based Auth: The authentication is handled by the reverse proxy. If the school is still using Microsoft and OpenID for authentication, then [mod_auth_openidc](https://github.com/zmartzone/mod_auth_openidc) should probably be used. I have some configuration samples at the end of this doc.

To get started with the backend, you need Python 3. Install the requirements by running `python3 -m pip install -r requirements.txt`. A [virtual environment](https://docs.python.org/3/library/venv.html) is recommended.

For development use, a reverse proxy is still required. The Django app will not serve any static files. After compiling the frontend, run `python3 manage.py collectstatic` to put all static served files in the `public` directory at the root of this project. Example Apache configuration is attached.

### Frontend

The frontend is served entirely by the reverse proxy. It is a combination of both the static files required by the Django admin page as well as the files compiled down from Vue. The frontend is a fairly bog-standard Vue 3 and Vue-Router 4 app. In the "static" directory, the images are kept (so if the school updates the logo, that is where you would change it).

To build the frontend, [Yarn](https://yarnpkg.com) is required. Build with `yarn build`.

## Deploying

### Deploying with Apache

Apache is what is probably going to be used because I know how to use it. If you want to switch to Nginx or something else, ask yourself, "Is this really worth the time and effort?" The answer is probably no. If you want to continue, make sure that the solution you design is secure and can send headers and authenticate via OpenIDC or Oauth2 or something else.

Most important thing to know is that this project is running with Gunicorn. To start Gunicorn, run `gunicorn project.wsgi` from the `backend` folder. This must be running to serve the API. By default, it should listen on port 8000. If you change the port, make sure that you change it in the configuration too. I have attached only the relevant configuration since the rest should be fairly simple (if you know Apache).

```
# Change this to the actual domain this is running on
ServerName pos.localdomain
# Change these following lines to match where the collected static data is
Alias / /pos/static/
Alias /admin/css /pos/static/admin/css
Alias /admin/fonts /pos/static/admin/fonts
Alias /admin/img /pos/static/admin/img
Alias /admin/js /pos/static/admin/js
ProxyPass "/admin/css" !
ProxyPass "/admin/fonts" !
ProxyPass "/admin/img" !
ProxyPass "/admin/js" !
ProxyPass "/api" "http://localhost:8000/api"
ProxyPass "/admin" "http://localhost:8000/admin"

# Change this to where the media directory is
Alias /media /pos/config/media

OIDCSessionType server-cache:persistent
OIDCSessionCacheFallbackToCookie Off
OIDCStateMaxNumberOfCookies 10 true

# If this is changed, make sure that you change the AUTH_HEADER env var.
OIDCAuthNHeader djangouser

# This all should be set properly. See https://github.com/zmartzone/mod_auth_openidc
OIDCProviderMetadataURL https://auth.example.com/.well-known/openid-configuration
OIDCClientID program-of-studies
OIDCClientSecret SETME

# Preserve POST Requests
OIDCPreservePost On

# OIDCRedirectURI is a vanity URL that must point to a path protected by this module but must NOT point to any content
OIDCRedirectURI http://pos.localdomain/admin/r
OIDCCryptoPassphrase SOMETHINGLONGANDSECURE
OIDCRemoteUserClaim preferred_username # This may vary from OpenID provider to provider.
ErrorDocument 401 'Sign-in failed. Are you allowed access?'

OIDCSessionInactivityTimeout 10

<Location />
	FallbackResource /index.html
</Location>

<Location /admin>
  AuthType openid-connect
	<RequireAll>
		Require valid-user
    # Here is where you would add a filter for the group
	</RequireAll>
</Location>

# By default Apache times out connections after one minute
ProxyTimeout 86400
```

### Deploying with Docker and Apache

Despite the name of this section, this also works fine under [Podman](https://podman.io).

Build the image with `docker build -t program-of-studies .`

Before running, create the following folders: A configuration folder (`config`), and under that, a media folder (`media`). In the config folder, place the SQLite database (as `db.sqlite3`) and the relevant uploaded media under `media`. This will be taken from the running program.

Run the image with `docker run --name pos --env-file env.env -v ./config:/config --net=host program-of-studies:latest`

It is very important that you set the data in the `env.env` file. Example configuration:

```
SECRET_KEY=LONGSECRET
DOMAIN=pos.localdomain # Change me
AUTH_HEADER=HTTP_DJANGOUSER # Must start with `HTTP_`. If the Apache header is `hello`, then the value here must be `HTTP_HELLO`.
```

Export the static directory and save it to the host machine: `podman cp pos:/app/frontend/public static` where `pos` is the name of the container.

Run this where the config directory exists and is available for Apache. Make sure that Apache has access to these directories:

```

<Directory /pos/static>
    AllowOverride none
    Require all granted
</Directory>

<Directory /pos/config/media>
    AllowOverride none
    Require all granted
</Directory>
```

Under \*nix systems, make sure that the locations have suitable permissions: directories must be world readable and executable (executable permission allows for traversal) and files must be world readable.

Well, that's it! Good luck.
